<html>
	<head>		
		<script src="vendors/kinetic-v4.0.1.min.js"></script>
		<script src="vendors/jquery-1.8.1.min.js"></script>
		<script src="2dgameeng.js"></script>
		<script src="vendors/stats.js"></script>
	</head>
	<body>
		<a id='starter' href="#">Start!</a>
		<a id='stopper' href="#">Stop!</a><br />
		<a id='profile-start' href='#'>Start profile</a>
		<a id='profile-stop' href='#'>Stop profile</a>
		<div id="canvas-world">
		</div>
		<script>
			var worker;
			// kinetic
			var stage, layer, anim;
			var stats;

			$(function(){
				var SCALE = 30;
				
				$('#profile-start').click(function(){ console.profile('Profile ...'); });
				$('#profile-stop').click(function(){ console.profileEnd(); });
				
				stats = new Stats();					
				document.body.appendChild(stats.domElement);				
				
				stage = new Kinetic.Stage({
					container: "canvas-world",
					width: 900,
					height: 600
				});
				layer = new Kinetic.Layer();

				(function(){
					var background = new Kinetic.Rect({
						x: 0,
						y: 0,
						width: stage.getWidth(),
						height: stage.getHeight(),
						fill: "black",
					});					
					layer.add(background);					
				})();

				var entities = {};
				entities['circle1'] = { 
					type:'circle', 
					radius:10 / SCALE, 
					x: 100 / SCALE, 
					y: 100 / SCALE, 
					angle:0, 
					id: 'circle1'};
				//---
				for(var i = 2; i < 200; ++i){
					entities['circle' + i] = { 
						type:'circle', 
						radius:10 / SCALE, 
						x: Math.random() * 450 / SCALE, 
						y: Math.random() * 300 / SCALE, 
						angle:0, 
						id: 'circle' + i};				
				}/**/
				
				entities['triangle1'] = {
					type:'polygon',
					points:[{x: 1 / SCALE, y: 1 / SCALE}, {x: 31 / SCALE, y: 1 / SCALE}, {x: 1 / SCALE, y: 61 / SCALE}],
					x: 120 / SCALE,
					y: 120 / SCALE,
					angle: 0,
					id: 'triangle1'
				};/**/

				worker = new Worker('exec2.js');
				worker.addEventListener('error', function(e){
					console.warn('Error!');
					console.error(e);
				});
				worker.addEventListener('message', function(event){					
					if(event.data.err){
						console.log('ERROR:', event.data);
						return;
					}
					
					if(event.data.name === 'update') {
						var newData = event.data.data;
						for(var id in newData){
							entities[id].x = newData[id].x;
							entities[id].y = newData[id].y;
							entities[id].angle = newData[id].a;
						}						
					}					

					if(event.data.name === 'create'){
						worker.postMessage({name:'appendBodies', data:entities } );
					}

					if(event.data.name === 'appendBodies'){
						worker.postMessage({name:'start', data:entities} );
					}
					
					if(event.data.name === 'start'){
						// After appending, attach the drawing function ... which also creates the visual
						// representations ...
						for(var k in entities){
							(function(entity){
							
								entity.draw = (function(_this){
									var obj; 
									var lastAngle = _this.angle;
									var lastX = _this.x;
									var lastY = _this.y;
									
									if(_this.type === 'circle'){
										obj = new Kinetic.Circle({
											radius: _this.radius * SCALE,
											fill: "red",
											stroke: "yellow",
											strokeWidth: 2,
											x: _this.x * SCALE,
											y: _this.y * SCALE
										});
									} else if(_this.type === 'polygon'){
										obj = new Kinetic.Polygon({
											points: entity.points.map(function(e){ return [e.x * SCALE, e.y * SCALE]; }).reduce(function(t, i){ return t.concat(i)},[]),
											fill: "red",
											stroke: "yellow",
											strokeWidth: 2,
											x: _this.x * SCALE,
											y: _this.y * SCALE
										});
									}

									layer.add(obj);
									obj.moveToTop();
									
									return function(){
										if(_this.x != lastX) {
											obj.setX(_this.x * SCALE);
											lastX = _this.x;
										}
										if(_this.y != lastY) {
											obj.setY(_this.y * SCALE);
											lastY = _this.y;
										}
										if(_this.angle != lastAngle){
											obj.rotate( _this.angle - lastAngle );
											lastAngle = _this.angle;
										}
									}
								})(entity);
								
							})(entities[k]);
						}
																		
						stage.add(layer);
						
						// Start drawing!
						anim = new Kinetic.Animation({
						  func: (function(){
									var ready = true;
									return function(frame) {
										if(ready){
											ready = false;

											for(var k in entities) {
												entities[k].draw();
											}

											stats.update();
											
											ready = true;
										}
									};
								})(),
						  node: layer
						});
						anim.start();
					}

					if(event.data.name === 'debug'){
						console.log(event.data.data);
					}
					
					/*setTimeout(function __tagTimeout(){
						worker.postMessage({name: "applyForce", data: { id: 'triangle1', degrees: (Math.random(360) - 180), power: 0.10}});
						worker.postMessage({name: "applyImpulse", data: { id: 'circle1', degrees: (Math.random(360) - 180), power: 0.01}});
						
						setTimeout(__tagTimeout, 1000);
					}, 1000);*/
					
				
				}); // worker.addEventListener(function(event){ ...
				
				// Ready to start ...
				$('#starter').click(function(){ 
					worker.postMessage({name:'create', data:{ scale: SCALE, width: 900 /*stage.GetWidth()*/, height: 600 /*stage.getHeight()*/ }}); 
					
					// Remove onClick to starter...
					$('#starter').click(function(){ });
					 					
					// Add onClick to stopper
					$('#stopper').click(function(){
						anim.stop();
						worker.postMessage({name:'close'});
					});
				});
				
			}); // $(function(){ ...
			
			
		</script>
		<div id="stats"></div>
	</body>
</html>