<html>
	<head>		
		<script src="vendors/kinetic-v4.0.1.min.js"></script>
		<script src="vendors/jquery-1.8.1.min.js"></script>
		<script src="2dgameeng.js"></script>
	</head>
	<body>
		<a id='starter' href="#">Start!</a>
		<div id="canvas-world">
		</div>
		<script>
			var worker = new Worker('exec2.js');
			// kinetic
			var stage, layer;

			$(function(){
				var SCALE = 30;
				
				stage = new Kinetic.Stage({
					container: "canvas-world",
					width: 900,
					height: 600
				});
				layer = new Kinetic.Layer();

				(function(){
					var background = new Kinetic.Rect({
						x: 0,
						y: 0,
						width: stage.getWidth(),
						height: stage.getHeight(),
						fill: "black",
					});					
					layer.add(background);					
				})();

				var entities = {};
				entities['circle1'] = { 
					type:'circle', 
					radius:10 / SCALE, 
					x: 100 / SCALE, 
					y: 100 / SCALE, 
					angle:0, 
					id: 'circle1'};
				//---
				/*for(var i = 2; i < 10; ++i){
					entities['circle' + i] = { 
						type:'circle', 
						radius:10 / SCALE, 
						x: Math.random(450) / SCALE, 
						y: Math.random(300) / SCALE, 
						angle:0, 
						id: 'circle' + i};				
				}*/
				
				entities['triangle1'] = {
					type:'polygon',
					points:[{x: 1 / SCALE, y: 1 / SCALE}, {x: 31 / SCALE, y: 1 / SCALE}, {x: 1 / SCALE, y: 61 / SCALE}],
					x: 120 / SCALE,
					y: 120 / SCALE,
					angle: 0,
					id: 'triangle1'
				};/**/

				worker.addEventListener('message', function(event){					
					if(event.data.err){
						console.log('ERROR:', event.data);
						return;
					}
					
					if(event.data.name === 'update') {
						var newData = event.data.data;
						for(var id in newData){
							entities[id].x = newData[id].x;
							entities[id].y = newData[id].y;
							entities[id].angle = newData[id].a;
						}						
					}					

					if(event.data.name === 'create'){
						worker.postMessage({name:'appendBodies', data:entities } );
					}

					if(event.data.name === 'appendBodies'){
						worker.postMessage({name:'start', data:entities} );
						
						// After appending, attach the drawing function ... which also creates the visual
						// representations ...
						for(var k in entities){
							(function(entity){
							
								entity.draw = (function(_this){
									var obj, angle = _this.angle;
									
									if(_this.type === 'circle'){
										obj = new Kinetic.Circle({
											radius: _this.radius * SCALE,
											fill: "red",
											stroke: "yellow",
											strokeWidth: 2,
											x: _this.x * SCALE,
											y: _this.y * SCALE
										});
									} else if(_this.type === 'polygon'){
										obj = new Kinetic.Polygon({
											points: entity.points.map(function(e){ return [e.x * SCALE, e.y * SCALE]; }).reduce(function(t, i){ return t.concat(i)},[]),
											fill: "red",
											stroke: "yellow",
											strokeWidth: 2,
											x: _this.x * SCALE,
											y: _this.y * SCALE
										});
									}

									layer.add(obj);
									obj.moveToTop();
									
									return function(){
																				
										obj.setX(_this.x * SCALE);
										obj.setY(_this.y * SCALE);
										obj.rotate( _this.angle - angle );
										
										angle = _this.angle;
									}
								})(entity);
								
							})(entities[k]);
						}
																		
						stage.add(layer);
						
						// Start drawing!
						var anim = new Kinetic.Animation({
						  func: function(frame) {
							for(var k in entities) {
								entities[k].draw();
							}
						  },
						  node: layer
						});
						anim.start();
					}

					if(event.data.name === 'debug'){
						console.log(event.data.data);
					}
					
					setTimeout(function __tagTimeout(){
						worker.postMessage({name: "applyForce", data: { id: 'triangle1', degrees: Math.random(360), power: 0.10}});
						worker.postMessage({name: "applyImpulse", data: { id: 'circle1', degrees: Math.random(360), power: 0.01}});
						
						setTimeout(__tagTimeout, 1000);
					}, 1000);
					
				
				}); // worker.addEventListener(function(event){ ...
				
				$('#starter').click(function(){ worker.postMessage({name:'create', data:{ scale: SCALE, width: 900 /*stage.GetWidth()*/, height: 600 /*stage.getHeight()*/ }}); });
				
			}); // $(function(){ ...
			
			
		</script>
	</body>
</html>