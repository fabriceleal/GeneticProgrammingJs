<html>
<head>
<script src="vendors/jquery-1.8.1.min.js"></script>
<script src="vendors/jquery.flot.js"></script>
<script type="text/javascript">
	// So it can be accessed from the browser console, for testing ...
	var worker;
	var hideOrShowLogs;
	var go;
	
	$(function(){		
		var optimize = 'function(x){ return x*x + x + 1; }';
		
		var plot = $('#plot');
		var logs = $('#logs-content');
		var status = $('#status');
		
		worker = new Worker("exec.js");
		
		// Plot the function to approximate
		var inputValues = [], testValues = [], original, fn = eval('(function(){ return (' + optimize + ');})()');
		for(var i = -1, y = 0; i <=1; i+=0.1, ++y){
			inputValues.push(i);
			testValues.push(fn(i));
		}
		original = inputValues.map(function(i, idx){ return [i, testValues[idx] ];})
		
		logs.append(new Date() + ': to approximate: ' + testValues.join(', ') + '<br/ >');

		worker.addEventListener("message", function(event){
			logs.append(new Date() + ': ' + event.data.name + ' result: ' + JSON.stringify(event.data.data) + "<br/ > ");

			if(event.data.data.err) {
				status.html('Err! Check the logs, try again!');
				return;
			}
			
			if(event.data.name === "load"){				
				worker.postMessage({ name:"generator", data: { maxDepth: 10 }});
			}
			if(event.data.name === "generator"){
				worker.postMessage({ name:"population", data: { number: 50 } });
			}
			if(event.data.name === "population"){
				worker.postMessage({ name:"evolver" , data: { inputValues: inputValues, testValues:testValues }});
			}
			if(event.data.name === "evolver"){
				worker.postMessage({ name:"start" , data: { type: "evolve", arg: 7 }});
			}
			if(event.data.name === "start") {
				// plot best, if found
				if(!event.data.data.err && event.data.data.result){
					var best = eval('(function(){ return (' + event.data.data.result.best + ');})()');
					var bestData = inputValues.map(function(i){ return [i, best(i)];});

					status.html('Ok! Try again!');
					
					$.plot(plot, [{label:"original", data:original, points:{ show:true }}, {label:"best", data:bestData}]);
				}
			}
		}, false);

		// Start task ...
		go = function(){		
			// Set status
			status.html('Wait for it ...');
			
			// Clean plot ...
			$.plot(plot, [{label:"original", data:original, points:{ show:true }}]);
			
			// Start!
			worker.postMessage({ name:"load", data: { }});
		};
		go();
		
		hideOrShowLogs = (function(){
			// First run, set text and hide
			var hidden = true;
			var a = $('#hide-show-logs-a');
			var l = $('#logs');
			a.html('Show logs');
			l.hide();
			
			// Function to toogle logs visible/invisible
			return function(){
				hidden = !hidden;
				if(hidden) {
					l.hide("slow");
					a.html('Show logs');
				} else {
					l.show("slow");
					a.html('Hide logs');
				}
			};
		})();		
	});

</script>
</head>
	<body>
		<h1>Genetic programming with madmonkey and gpjs</h1>
		<h2>Approximate numerical function R -> R</h2>
		<div>This sample will generate a small range of values and then use genetic programming to "reverse-engineer" the original function.</div>
		<br/ >
		<div id="parameters"></div>
		<div id="plot" style="width:600px;height:300px"></div>
		<b><div id="status"></div></b>
		<a id="try" href="javascript:go()">Try!</a><br/ >
		<a id="hide-show-logs-a" href="javascript:hideOrShowLogs()"></a>
		<div id="logs">		
			<i>If the best error is something like 4.440892098500626e-16, one can say that we matched the original function!</i><br/ >
			<b>Logs:</b><br/ ><a href="javascript:(function(){ $('#logs-content').html(''); })()">Clear logs</a>
			<div id="logs-content"></div>
		</div>
		<br/ >
		<i>Plot generated using <a href="http://www.flotcharts.org/">flot</a>. <br/>
		Genetic programming implemented with <a href="https://github.com/fabriceleal/MadMonkeyJs">madmonkey</a> and <a href="https://github.com/fabriceleal/GeneticProgrammingJs">gpjs</a>.</i>
	</body>
</html>
